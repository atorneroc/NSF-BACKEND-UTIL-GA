name: "Backend CI/CD (.NET 8)"

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  id-token: write
  contents: read
  security-events: write

jobs:
  ci:
    uses: ./.github/workflows/templates/dotnet-ci.yml
    with:
      solution: "nsf-backend-util.sln"
      test_project: "./Scharff.UnitTest/Scharff.UnitTest.csproj"

  analyze:
    needs: ci
    uses: ./.github/workflows/templates/analyze-security.yml
    with:
      solution: "nsf-backend-util.sln"
      sonar_project_key: "atorneroc_NSF-BACKEND-UTIL-GA"
      sonar_org: "atorneroc"
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  deploy:
    needs: ci
    if: github.event_name == 'push'
    uses: ./.github/workflows/templates/deploy-azure.yml
    with:
      app_name: "nsf-backend-ga"
      slot: "production"
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
