name: "Backend CI/CD (.NET 8 + Azure)"

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  id-token: write
  contents: read
  actions: read
  security-events: write

jobs:
  # -------------------------------
  # ğŸ§ª CI: Build + Test
  # -------------------------------
  ci:
    uses: ./.github/workflows/dotnet-ci.yml
    with:
      solution: "nsf-backend-util.sln"
      test_project: "./Scharff.UnitTest/Scharff.UnitTest.csproj"
    secrets: inherit

  # -------------------------------
  # ğŸ” AnÃ¡lisis de seguridad (CodeQL + SonarCloud)
  # -------------------------------
  analyze:
    needs: ci
    uses: ./.github/workflows/analyze-security.yml
    with:
      solution: "nsf-backend-util.sln"
      sonar_project_key: "atorneroc_NSF-BACKEND-UTIL-GA"
      sonar_org: "atorneroc"
    secrets: inherit

  # -------------------------------
  # ğŸ³ Build + Scan + Push a ACR
  # -------------------------------
  docker:
    if: github.event_name == 'push'
    needs: [ci, analyze]
    uses: ./.github/workflows/docker-build-acr.yml
    secrets: inherit

  # -------------------------------
  # ğŸš€ Despliegue 1: App Service por CÃ³digo
  # -------------------------------
  deploy:
    if: ${{ success() && github.event_name == 'push' }}
    needs: docker
    uses: ./.github/workflows/deploy-azure.yml
    with:
      app_name: "nsf-backend-ga"
      slot: "production"
    secrets: inherit

  # -------------------------------
  # ğŸš€ Despliegue 2: App Service por Contenedor
  # -------------------------------
  deploy-container:
    if: ${{ success() && github.event_name == 'push' }}
    needs: docker
    uses: ./.github/workflows/deploy-azure-container.yml
    with:
      app_name: "nsf-backend-ga-cont"          # ğŸ‘ˆ App Service con ACR
      acr_name: "nsfacrdev"
      image_name: "nsf-backend-util"
      image_tag: ${{ needs.docker.outputs.version }}
      slot: "production"
    secrets: inherit
