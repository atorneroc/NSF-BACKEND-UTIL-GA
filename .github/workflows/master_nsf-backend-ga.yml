name: "Backend CI/CD (.NET 8)"

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  id-token: write
  contents: read
  actions: read
  security-events: write

jobs:
  # -------------------------------
  # üß™ CI: Build + Test
  # -------------------------------
  ci:
    uses: ./.github/workflows/dotnet-ci.yml
    with:
      solution: "nsf-backend-util.sln"
      test_project: "./Scharff.UnitTest/Scharff.UnitTest.csproj"

  # -------------------------------
  # üîç An√°lisis de seguridad
  # -------------------------------
  analyze:
    needs: ci
    uses: ./.github/workflows/analyze-security.yml
    with:
      solution: "nsf-backend-util.sln"
      sonar_project_key: "atorneroc_NSF-BACKEND-UTIL-GA"
      sonar_org: "atorneroc"
    secrets:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    permissions:
      actions: read
      contents: read
      security-events: write

  # -------------------------------
  # üê≥ Build + Scan + Push a ACR
  # -------------------------------
  docker:
    if: github.event_name == 'push'
    needs: [ci, analyze]
    uses: ./.github/workflows/docker-build-acr.yml
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # -------------------------------
  # üöÄ Despliegue 1: App Service por C√≥digo
  # -------------------------------
  deploy:
    if: ${{ success() && github.event_name == 'push' }}
    needs: docker
    uses: ./.github/workflows/deploy-azure.yml
    with:
      app_name: "nsf-backend-ga"
      slot: "production"
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

  # -------------------------------
  # üöÄ Despliegue 2: App Service por Contenedor
  # -------------------------------
  deploy-container:
    if: ${{ success() && github.event_name == 'push' }}
    needs: docker
    uses: ./.github/workflows/deploy-azure-container.yml
    with:
      app_name: "nsf-backend-ga-cont"          # üëà tu App Service basado en ACR
      acr_name: "nsfacrdev"
      image_name: "nsf-backend-util"
      image_tag: "latest"
      slot: "production"
    secrets:
      AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
      AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
      AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
