name: "Security Analysis Template"

on:
  workflow_call:
    inputs:
      solution:
        required: true
        type: string
      sonar_project_key:
        required: true
        type: string
      sonar_org:
        required: true
        type: string
    secrets:
      SONAR_TOKEN:
        required: true    

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    env:
      SOLUTION_PATH: ${{ inputs.solution }}
      SONAR_PROJECT_KEY: ${{ inputs.sonar_project_key }}
      SONAR_ORG: ${{ inputs.sonar_org }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

    steps:
      - name: ğŸ§° Checkout del cÃ³digo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: âš™ï¸ Configurar .NET 8
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'

      # -----------------------
      # ğŸ” CodeQL
      # -----------------------
      - name: ğŸ§ª Inicializar CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: csharp
          build-mode: manual
          queries: security-and-quality

      - name: ğŸ—ï¸ Compilar proyecto
        run: |
          echo "ğŸ” Restaurando dependencias para $SOLUTION_PATH"
          dotnet restore "$SOLUTION_PATH"
          echo "ğŸ—ï¸ Compilando proyecto $SOLUTION_PATH en modo Release"
          dotnet build "$SOLUTION_PATH" --configuration Release --no-restore

      - name: ğŸ” Ejecutar anÃ¡lisis CodeQL
        uses: github/codeql-action/analyze@v4

      # -----------------------
      # ğŸ§­ SonarCloud
      # -----------------------
      - name: ğŸ§© Instalar SonarScanner
        run: |
          dotnet tool update --global dotnet-sonarscanner || dotnet tool install --global dotnet-sonarscanner
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: ğŸš€ AnÃ¡lisis SonarCloud Begin
        run: |
          dotnet sonarscanner begin \
            /k:"$SONAR_PROJECT_KEY" \
            /o:"$SONAR_ORG" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.login="$SONAR_TOKEN" \
            /d:sonar.exclusions="**/bin/**,**/obj/**,**/Migrations/**"

      - name: ğŸ—ï¸ Build para Sonar
        run: dotnet build "$SOLUTION_PATH" --configuration Release --no-restore

      - name: ğŸ§ª Tests con cobertura
        run: |
          dotnet test ./Scharff.UnitTest/Scharff.UnitTest.csproj \
            --configuration Release \
            --no-build \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults

      - name: ğŸ Finalizar anÃ¡lisis SonarCloud
        run: dotnet sonarscanner end /d:sonar.login="$SONAR_TOKEN"
