name: "Security Analysis Template"

on:
  workflow_call:
    inputs:
      solution:
        required: true
        type: string
      sonar_project_key:
        required: true
        type: string
      sonar_org:
        required: true
        type: string
    secrets:
      SONAR_TOKEN:
        required: true    

jobs:
  security-scan:
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    env:
      SOLUTION_PATH: ${{ inputs.solution }}
      SONAR_PROJECT_KEY: ${{ inputs.sonar_project_key }}
      SONAR_ORG: ${{ inputs.sonar_org }}
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      SHOULD_RUN_SONAR: ${{ github.actor != 'dependabot[bot]' }}


    steps:
      - name: üß∞ Checkout del c√≥digo
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: ‚öôÔ∏è Configurar .NET 8
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '8.0.x'

      # -----------------------
      # üîç CodeQL
      # -----------------------
      - name: üß™ Inicializar CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: csharp
          build-mode: manual
          queries: security-and-quality

      - name: üèóÔ∏è Compilar proyecto
        run: |
          echo "üîç Restaurando dependencias para $SOLUTION_PATH"
          dotnet restore "$SOLUTION_PATH"
          echo "üèóÔ∏è Compilando proyecto $SOLUTION_PATH en modo Release"
          dotnet build "$SOLUTION_PATH" --configuration Release --no-restore

      - name: üîé Ejecutar an√°lisis CodeQL
        uses: github/codeql-action/analyze@v3

      # -----------------------
      # üß≠ SonarCloud
      # -----------------------
      - name: üß© Instalar SonarScanner
        if: env.SHOULD_RUN_SONAR == 'true'
        run: |
          dotnet tool update --global dotnet-sonarscanner || dotnet tool install --global dotnet-sonarscanner
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: üöÄ An√°lisis SonarCloud Begin
        if: env.SHOULD_RUN_SONAR == 'true'
        run: |
          dotnet sonarscanner begin \
            /k:"$SONAR_PROJECT_KEY" \
            /o:"$SONAR_ORG" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.login="$SONAR_TOKEN" \
            /d:sonar.analysis.key="${{ github.run_id }}" \
            /d:sonar.analysis.name="CI-${{ github.run_number }}" \
            /d:sonar.exclusions="**/bin/**,**/obj/**,**/Migrations/**"

      - name: üèóÔ∏è Build para Sonar
        if: env.SHOULD_RUN_SONAR == 'true'
        run: dotnet build "$SOLUTION_PATH" --configuration Release --no-restore

      - name: üß™ Tests con cobertura
        if: env.SHOULD_RUN_SONAR == 'true'
        run: |
          dotnet test ./Scharff.UnitTest/Scharff.UnitTest.csproj \
            --configuration Release \
            --no-build \
            --collect:"XPlat Code Coverage" \
            --results-directory ./TestResults

      - name: üèÅ Finalizar an√°lisis SonarCloud
        if: env.SHOULD_RUN_SONAR == 'true'
        run: dotnet sonarscanner end /d:sonar.login="$SONAR_TOKEN"
